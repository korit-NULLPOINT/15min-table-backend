<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nullpoint.fifteenmintable.mapper.RecipeMapper">
    <resultMap id="RecipeResultMap" type="com.nullpoint.fifteenmintable.entity.Recipe">
        <id property="recipeId" column="recipe_id"/>
        <result property="boardId" column="board_id"/>
        <result property="mainCategoryId" column="main_category_id"/>
        <result property="subCategoryId" column="sub_category_id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="recipe_title"/>
        <result property="intro" column="intro"/>
        <result property="thumbnailImgUrl" column="thumbnail_img_url"/>
        <result property="ingredients" column="ingredients"/>
        <result property="ingredientImgUrl" column="ingredient_img_url"/>
        <result property="steps" column="steps"/>
        <result property="viewCount" column="view_count"/>
        <result property="createDt" column="recipe_create_dt"/>
        <result property="updateDt" column="recipe_update_dt"/>
        <association property="board" resultMap="BoardResultMap"/>
        <association property="mainCategory" resultMap="MainCategoryResultMap"/>
        <association property="subCategory" resultMap="SubCategoryResultMap"/>
    </resultMap>
    <resultMap id="BoardResultMap" type="com.nullpoint.fifteenmintable.entity.Board">
        <id property="boardId" column="board_id"/>
        <result property="title" column="board_title"/>
        <result property="boardTypeId" column="board_type_id"/>
        <result property="createDt" column="board_create_dt"/>
        <result property="updateDt" column="board_update_dt"/>
        <association property="boardType" resultMap="BoardTypeResultMap"/>
    </resultMap>
    <resultMap id="BoardTypeResultMap" type="com.nullpoint.fifteenmintable.entity.BoardType">
        <id property="boardTypeId" column="board_type_id"/>
        <result property="boardTypeName" column="board_type_name"/>
        <result property="boardTypeNameKor" column="board_type_name_kor"/>
    </resultMap>
    <resultMap id="MainCategoryResultMap" type="com.nullpoint.fifteenmintable.entity.MainCategory">
        <id property="mainCategoryId" column="main_category_id"/>
        <result property="name" column="main_cate_name"/>
    </resultMap>
    <resultMap id="SubCategoryResultMap" type="com.nullpoint.fifteenmintable.entity.SubCategory">
        <id property="subCategoryId" column="main_category_id"/>
        <result property="name" column="sub_cate_name"/>
    </resultMap>
    <insert id="createRecipe" useGeneratedKeys="true" keyProperty="recipeId">
        insert into
        recipe_tb
        values
        (0, #{boardId}, #{mainCategoryId}, #{subCategoryId}, #{userId}, #{title}, #{intro}, #{thumbnailImgUrl}, #{ingredients}, #{ingredientImgUrl}, #{steps}, 0, now(), null);
    </insert>

    <select id="findAll" resultMap="RecipeResultMap">
        select
        rt.recipe_id,
        rt.board_id,
        rt.main_category_id,
        rt.sub_category_id,
        rt.user_id,
        rt.title as recipe_title,
        rt.intro,
        rt.thumbnail_img_url,
        rt.ingredients,
        rt.ingredient_img_url,
        rt.steps,
        rt.view_count,
        rt.create_dt as recipe_create_dt,
        rt.update_dt as recipe_update_dt,

        bt.title as board_title,
        bt.board_type_id,
        bt.create_dt as board_create_dt,
        bt.update_dt as board_update_dt,

        btt.board_type_name,
        btt.board_type_name_kor,

        mct.name as main_cate_name,
        sct.name as sub_cate_name
        from
        recipe_tb rt
        join board_tb bt on (rt.board_id = bt.board_id)
        join board_type_tb btt on (btt.board_type_id = bt.board_type_id)
        join main_category_tb mct on (mct.main_category_id = rt.main_category_id)
        join sub_category_tb sct on (sct.sub_category_id = rt.sub_category_id)

    </select>
    <select id="findByRecipeId" resultMap="RecipeResultMap">
        select
        rt.recipe_id,
        rt.board_id,
        rt.main_category_id,
        rt.sub_category_id,
        rt.user_id,
        rt.title as recipe_title,
        rt.intro,
        rt.thumbnail_img_url,
        rt.ingredients,
        rt.ingredient_img_url,
        rt.steps,
        rt.view_count,
        rt.create_dt as recipe_create_dt,
        rt.update_dt as recipe_update_dt,

        bt.title as board_title,
        bt.board_type_id,
        bt.create_dt as board_create_dt,
        bt.update_dt as board_update_dt,

        btt.board_type_name,
        btt.board_type_name_kor,

        mct.name as main_cate_name,
        sct.name as sub_cate_name
        from
        recipe_tb rt
        join board_tb bt on (rt.board_id = bt.board_id)
        join board_type_tb btt on (btt.board_type_id = bt.board_type_id)
        join main_category_tb mct on (mct.main_category_id = rt.main_category_id)
        join sub_category_tb sct on (sct.sub_category_id = rt.sub_category_id)
        where
        rt.recipe_id = #{recipeId};
    </select>
    <select id="findByUserId" resultMap="RecipeResultMap">
        select
        rt.recipe_id,
        rt.board_id,
        rt.main_category_id,
        rt.sub_category_id,
        rt.user_id,
        rt.title as recipe_title,
        rt.intro,
        rt.thumbnail_img_url,
        rt.ingredients,
        rt.ingredient_img_url,
        rt.steps,
        rt.view_count,
        rt.create_dt as recipe_create_dt,
        rt.update_dt as recipe_update_dt,

        bt.title as board_title,
        bt.board_type_id,
        bt.create_dt as board_create_dt,
        bt.update_dt as board_update_dt,

        btt.board_type_name,
        btt.board_type_name_kor,

        mct.name as main_cate_name,
        sct.name as sub_cate_name
        from
        recipe_tb rt
        join board_tb bt on (rt.board_id = bt.board_id)
        join board_type_tb btt on (btt.board_type_id = bt.board_type_id)
        join main_category_tb mct on (mct.main_category_id = rt.main_category_id)
        join sub_category_tb sct on (sct.sub_category_id = rt.sub_category_id)
        where
        rt.user_id = #{userId};
    </select>
    <select id="findByMainCategoryId" resultMap="RecipeResultMap">
        select
        rt.recipe_id,
        rt.board_id,
        rt.main_category_id,
        rt.sub_category_id,
        rt.user_id,
        rt.title as recipe_title,
        rt.intro,
        rt.thumbnail_img_url,
        rt.ingredients,
        rt.ingredient_img_url,
        rt.steps,
        rt.view_count,
        rt.create_dt as recipe_create_dt,
        rt.update_dt as recipe_update_dt,

        bt.title as board_title,
        bt.board_type_id,
        bt.create_dt as board_create_dt,
        bt.update_dt as board_update_dt,

        btt.board_type_name,
        btt.board_type_name_kor,

        mct.name as main_cate_name,
        sct.name as sub_cate_name
        from
        recipe_tb rt
        join board_tb bt on (rt.board_id = bt.board_id)
        join board_type_tb btt on (btt.board_type_id = bt.board_type_id)
        join main_category_tb mct on (mct.main_category_id = rt.main_category_id)
        join sub_category_tb sct on (sct.sub_category_id = rt.sub_category_id)
        where
        rt.main_category_id = #{mainCategoryId};
    </select>
    <select id="findBySubCategoryId" resultMap="RecipeResultMap">
        select
        rt.recipe_id,
        rt.board_id,
        rt.main_category_id,
        rt.sub_category_id,
        rt.user_id,
        rt.title as recipe_title,
        rt.intro,
        rt.thumbnail_img_url,
        rt.ingredients,
        rt.ingredient_img_url,
        rt.steps,
        rt.view_count,
        rt.create_dt as recipe_create_dt,
        rt.update_dt as recipe_update_dt,

        bt.title as board_title,
        bt.board_type_id,
        bt.create_dt as board_create_dt,
        bt.update_dt as board_update_dt,

        btt.board_type_name,
        btt.board_type_name_kor,

        mct.name as main_cate_name,
        sct.name as sub_cate_name
        from
        recipe_tb rt
        join board_tb bt on (rt.board_id = bt.board_id)
        join board_type_tb btt on (btt.board_type_id = bt.board_type_id)
        join main_category_tb mct on (mct.main_category_id = rt.main_category_id)
        join sub_category_tb sct on (sct.sub_category_id = rt.sub_category_id)
        where
        rt.sub_category_id = #{subCategoryId};
    </select>
    <select id="findByKeyword" resultMap="RecipeResultMap">
        select
        rt.recipe_id,
        rt.board_id,
        rt.main_category_id,
        rt.sub_category_id,
        rt.user_id,
        rt.title as recipe_title,
        rt.intro,
        rt.thumbnail_img_url,
        rt.ingredients,
        rt.ingredient_img_url,
        rt.steps,
        rt.view_count,
        rt.create_dt as recipe_create_dt,
        rt.update_dt as recipe_update_dt,

        bt.title as board_title,
        bt.board_type_id,
        bt.create_dt as board_create_dt,
        bt.update_dt as board_update_dt,

        btt.board_type_name,
        btt.board_type_name_kor,

        mct.name as main_cate_name,
        sct.name as sub_cate_name
        from
        recipe_tb rt
        join board_tb bt on (rt.board_id = bt.board_id)
        join board_type_tb btt on (btt.board_type_id = bt.board_type_id)
        join main_category_tb mct on (mct.main_category_id = rt.main_category_id)
        join sub_category_tb sct on (sct.sub_category_id = rt.sub_category_id)
        where
        rt.title like concat("%", #{keyword}, "%")
        or rt.intro like concat("%", #{keyword}, "%")
        or rt.steps like concat("%", #{keyword}, "%")
        order by
        bt.create_dt desc;
    </select>
    <update id="updateRecipe">
        update
        recipe_tb
        set
        main_category_id = #{mainCategoryId},
        sub_category_id = #{subCategoryId},
        title = #{title},
        intro = #{intro},
        thumbnail_img_url = #{thumbnailImgUrl},
        ingredients = #{ingredients},
        ingredient_img_url = #{ingredientImgUrl},
        steps = #{steps},
        update_dt = now()
        where
        recipe_id = #{recipeId}
    </update>
    <delete id="deleteRecipe">
        delete from
        recipe_tb
        where
        recipe_id = #{recipeId};
    </delete>
</mapper>