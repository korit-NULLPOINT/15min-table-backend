<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nullpoint.fifteenmintable.mapper.PostMapper">

    <resultMap id="PostResultMap" type="com.nullpoint.fifteenmintable.entity.Post">
        <id property="postId" column="post_id"/>
        <result property="boardId" column="board_id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="viewCount" column="view_count"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <resultMap id="PostListRespDtoResultMap" type="com.nullpoint.fifteenmintable.dto.post.PostListRespDto">
        <id property="postId" column="post_id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="title" column="title"/>
        <result property="profileImgUrl" column="profile_img_url"/>
        <result property="thumbnailImgUrl" column="thumbnail_img_url"/>
        <result property="viewCount" column="view_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <resultMap id="PostDetailRespDtoResultMap" type="com.nullpoint.fifteenmintable.dto.post.PostDetailRespDto">
        <id property="postId" column="post_id"/>
        <result property="boardId" column="board_id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="profileImgUrl" column="profile_img_url"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="viewCount" column="view_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <insert id="addPost" useGeneratedKeys="true" keyProperty="postId">
        insert into post_tb
            (board_id, user_id, title, content, view_count, create_dt, update_dt)
        values
            (#{boardId}, #{userId}, #{title}, #{content}, 0, now(), null)
    </insert>

    <update id="modifyPost">
        update
            post_tb
        set
            title = #{title},
            content = #{content},
            update_dt = now()
        where
            post_id = #{postId}
    </update>

    <delete id="deletePost">
        delete from
            post_tb
        where
            post_id = #{postId}
    </delete>

    <select id="getPostById" resultMap="PostResultMap">
        select
            pt.post_id,
            pt.board_id,
            pt.user_id,
            pt.title,
            pt.content,
            pt.view_count,
            pt.create_dt,
            pt.update_dt
        from
            post_tb pt
        where
            pt.post_id = #{postId}
    </select>

    <select id="getPostDetail" resultMap="PostDetailRespDtoResultMap">
        select
            pt.post_id,
            pt.board_id,
            pt.user_id,
            ut.username,
            ut.profile_img_url,
            pt.title,
            pt.content,
            pt.view_count,
            (
                select
                    count(*)
                from
                    comment_tb ct
                where
                    ct.target_type = 'POST'
                    and ct.target_id = pt.post_id
            ) as comment_count,
            pt.create_dt,
            pt.update_dt
        from
            post_tb pt
        join
            user_tb ut
            on ut.user_id = pt.user_id
        where
            pt.board_id = #{boardId}
            and pt.post_id = #{postId}
    </select>

    <update id="increaseViewCount">
        update
            post_tb
        set
            view_count = view_count + 1
        where
            post_id = #{postId}
    </update>

    <select id="getPostListByCursor" resultMap="PostListRespDtoResultMap">
        select
            pt.post_id,
            pt.user_id,
            ut.username,
            ut.profile_img_url,
            pt.title,
            pit.img_url as thumbnail_img_url,
            pt.view_count,
            (
                select count(*)
                    from comment_tb ct
                where
                    ct.target_type = 'POST'
                    and ct.target_id = pt.post_id
            ) as comment_count,
            pt.create_dt,
            pt.update_dt
        from
            post_tb pt
        join
            user_tb ut
            on ut.user_id = pt.user_id
        left join post_img_tb pit
            on pit.post_id = pt.post_id
            and pit.sort_order = 0
        where
            pt.board_id = #{boardId}

        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'TITLE'">
                    and pt.title like concat('%', #{keyword}, '%')
                </when>
                <when test="searchType == 'USERNAME'">
                    and ut.username like concat('%', #{keyword}, '%')
                </when>
                <otherwise>
                    and (
                        pt.title like concat('%', #{keyword}, '%')
                        or ut.username like concat('%', #{keyword}, '%')
                        )
                </otherwise>
            </choose>
        </if>

        <if test="cursorCreateDt != null and cursorPostId != null">
            and (
                pt.create_dt &lt; #{cursorCreateDt}
                or (pt.create_dt = #{cursorCreateDt} and pt.post_id &lt; #{cursorPostId})
                )
        </if>

        order by
            pt.create_dt desc, pt.post_id desc
        limit #{sizePlusOne}
    </select>

    <select id="getPostListByUserIdByCursor" resultMap="PostListRespDtoResultMap">
        select
            pt.post_id,
            pt.user_id,
            ut.username,
            ut.profile_img_url,
            pt.title,
            pit.img_url as thumbnail_img_url,
            pt.view_count,
            coalesce(ct.comment_count, 0) as comment_count,
            pt.create_dt,
            pt.update_dt
        from post_tb pt
        join user_tb ut
            on ut.user_id = pt.user_id
        left join post_img_tb pit
            on pit.post_id = pt.post_id
        and pit.sort_order = 0
        left join (
            select
                target_id as post_id, count(*) as comment_count
            from
                comment_tb
            where
                target_type = 'POST'
            group by
                target_id
            ) ct on ct.post_id = pt.post_id
        where
            pt.user_id = #{userId}

        <if test="cursorCreateDt != null and cursorPostId != null">
            and (
                pt.create_dt &lt; #{cursorCreateDt}
                or (pt.create_dt = #{cursorCreateDt} and pt.post_id &lt; #{cursorPostId})
            )
        </if>

        order by
            pt.create_dt desc, pt.post_id desc
        limit #{sizePlusOne}
    </select>
</mapper>
