<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nullpoint.fifteenmintable.mapper.ManageMapper">

    <resultMap id="AdminRecipeRespDtoMap" type="com.nullpoint.fifteenmintable.dto.admin.AdminRecipeRespDto">
        <id property="recipeId" column="recipe_id"/>
        <result property="userId" column="user_id"/>
        <result property="viewCount" column="view_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="title" column="title"/>
        <result property="username" column="username"/>
        <result property="profileImgUrl" column="profile_img_url"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <resultMap id="AdminPostRespDtoMap" type="com.nullpoint.fifteenmintable.dto.admin.AdminPostRespDto">
        <id property="postId" column="post_id"/>
        <result property="userId" column="user_id"/>
        <result property="viewCount" column="view_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="title" column="title"/>
        <result property="username" column="username"/>
        <result property="profileImgUrl" column="profile_img_url"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <resultMap id="AdminStatsRespDtoMap" type="com.nullpoint.fifteenmintable.dto.admin.AdminStatsRespDto">
        <result property="totalUsers" column="total_users"/>
        <result property="totalRecipes" column="total_recipes"/>
        <result property="totalPosts" column="total_posts"/>
    </resultMap>

    <resultMap id="AdminActivityRespDtoMap" type="com.nullpoint.fifteenmintable.dto.admin.AdminActivityRespDto">
        <result property="type" column="type"/>
        <result property="action" column="action"/>
        <result property="targetId" column="target_id"/>
        <result property="title" column="title"/>
        <result property="username" column="username"/>
        <result property="occurredAt" column="occurred_at"/>
    </resultMap>

    <resultMap id="AdminTimeSeriesPointDtoMap" type="com.nullpoint.fifteenmintable.dto.admin.AdminTimeSeriesPointDto">
        <result property="date" column="date"/>
        <result property="count" column="count"/>
    </resultMap>

    <select id="getAdminRecipeList" resultMap="AdminRecipeRespDtoMap">
        select
            rt.recipe_id,
            rt.user_id,
            rt.view_count,
            coalesce(ct.comment_count, 0) as comment_count,
            rt.title,
            ut.username,
            ut.profile_img_url,
            rt.create_dt,
            rt.update_dt
        from
            recipe_tb rt
            inner join user_tb ut
                on ut.user_id = rt.user_id
            left join (
                select
                    target_id as recipe_id,
                    count(*) as comment_count
                from
                    comment_tb
                where
                    target_type = 'RECIPE'
                group by
                    target_id
            ) ct
                on ct.recipe_id = rt.recipe_id
        where
            1 = 1

            <!-- keyword search: title or username -->
            <if test="keyword != null and keyword != ''">
                and (
                    rt.title like concat('%', #{keyword}, '%')
                    or ut.username like concat('%', #{keyword}, '%')
                )
            </if>

            <!-- keyset cursor -->
            <if test="cursorValue != null and cursorId != null">
                <choose>
                    <!-- sortKey: createDt -->
                    <when test="sortKey == 'createDt'">
                        <choose>
                            <when test="sortBy == 'asc'">
                                and (
                                    rt.create_dt &gt; #{cursorValue}
                                    or (rt.create_dt = #{cursorValue} and rt.recipe_id &gt; #{cursorId})
                                )
                            </when>
                            <otherwise>
                                and (
                                    rt.create_dt &lt; #{cursorValue}
                                    or (rt.create_dt = #{cursorValue} and rt.recipe_id &lt; #{cursorId})
                                )
                            </otherwise>
                        </choose>
                    </when>

                    <!-- sortKey: viewCount -->
                    <when test="sortKey == 'viewCount'">
                        <choose>
                            <when test="sortBy == 'asc'">
                                and (
                                    rt.view_count &gt; #{cursorValue}
                                    or (rt.view_count = #{cursorValue} and rt.recipe_id &gt; #{cursorId})
                                )
                            </when>
                            <otherwise>
                                and (
                                    rt.view_count &lt; #{cursorValue}
                                    or (rt.view_count = #{cursorValue} and rt.recipe_id &lt; #{cursorId})
                                )
                            </otherwise>
                        </choose>
                    </when>

                    <!-- fallback: createDt desc -->
                    <otherwise>
                        and (
                        rt.create_dt &lt; #{cursorValue}
                        or (rt.create_dt = #{cursorValue} and rt.recipe_id &lt; #{cursorId})
                        )
                    </otherwise>
                </choose>
            </if>

        <!-- order by -->
        <choose>
            <when test="sortKey == 'viewCount'">
                order by
                    rt.view_count
                    <choose>
                        <when test="sortBy == 'asc'">asc</when>
                        <otherwise>desc</otherwise>
                    </choose>,
                    rt.recipe_id
                    <choose>
                        <when test="sortBy == 'asc'">asc</when>
                        <otherwise>desc</otherwise>
                    </choose>
            </when>

            <otherwise>
                order by
                    rt.create_dt
                <choose>
                    <when test="sortBy == 'asc'">asc</when>
                    <otherwise>desc</otherwise>
                </choose>,
                rt.recipe_id
                <choose>
                    <when test="sortBy == 'asc'">asc</when>
                    <otherwise>desc</otherwise>
                </choose>
            </otherwise>
        </choose>

        limit #{size}
    </select>

    <select id="getAdminPostList" resultMap="AdminPostRespDtoMap">
        select
            pt.post_id,
            pt.user_id,
            pt.view_count,
            coalesce(ct.comment_count, 0) as comment_count,
            pt.title,
            ut.username,
            ut.profile_img_url,
            pt.create_dt,
            pt.update_dt
        from
            post_tb pt
            inner join user_tb ut
                on ut.user_id = pt.user_id
            left join (
                select
                    target_id as post_id,
                    count(*) as comment_count
                from
                    comment_tb
                where
                    target_type = 'POST'
                group by
                    target_id
            ) ct
                on ct.post_id = pt.post_id
        where
            1 = 1

            <!-- keyword search: title or username -->
            <if test="keyword != null and keyword != ''">
                and (
                    pt.title like concat('%', #{keyword}, '%')
                    or ut.username like concat('%', #{keyword}, '%')
                )
            </if>

            <!-- keyset cursor -->
            <if test="cursorValue != null and cursorId != null">
                <choose>
                    <!-- sortKey: createDt -->
                    <when test="sortKey == 'createDt'">
                        <choose>
                            <when test="sortBy == 'asc'">
                                and (
                                    pt.create_dt &gt; #{cursorValue}
                                    or (pt.create_dt = #{cursorValue} and pt.post_id &gt; #{cursorId})
                                )
                            </when>
                            <otherwise>
                                and (
                                    pt.create_dt &lt; #{cursorValue}
                                    or (pt.create_dt = #{cursorValue} and pt.post_id &lt; #{cursorId})
                                )
                            </otherwise>
                        </choose>
                    </when>

                    <!-- sortKey: viewCount -->
                    <when test="sortKey == 'viewCount'">
                        <choose>
                            <when test="sortBy == 'asc'">
                                and (
                                    pt.view_count &gt; #{cursorValue}
                                    or (pt.view_count = #{cursorValue} and pt.post_id &gt; #{cursorId})
                                )
                            </when>
                            <otherwise>
                                and (
                                    pt.view_count &lt; #{cursorValue}
                                    or (pt.view_count = #{cursorValue} and pt.post_id &lt; #{cursorId})
                                )
                            </otherwise>
                        </choose>
                    </when>

                    <!-- fallback: createDt desc -->
                    <otherwise>
                        and (
                            pt.create_dt &lt; #{cursorValue}
                            or (pt.create_dt = #{cursorValue} and pt.post_id &lt; #{cursorId})
                        )
                    </otherwise>
                </choose>
            </if>

        <!-- order by -->
        <choose>
            <when test="sortKey == 'viewCount'">
                order by
                    pt.view_count
                    <choose>
                        <when test="sortBy == 'asc'">asc</when>
                        <otherwise>desc</otherwise>
                    </choose>,
                    pt.post_id
                    <choose>
                        <when test="sortBy == 'asc'">asc</when>
                        <otherwise>desc</otherwise>
                    </choose>
            </when>

            <otherwise>
                order by
                    pt.create_dt
                    <choose>
                        <when test="sortBy == 'asc'">asc</when>
                        <otherwise>desc</otherwise>
                    </choose>,
                    pt.post_id
                    <choose>
                        <when test="sortBy == 'asc'">asc</when>
                        <otherwise>desc</otherwise>
                    </choose>
            </otherwise>
        </choose>
        limit #{size}
    </select>

    <select id="getDashboardStats" resultMap="AdminStatsRespDtoMap">
        select
            (select count(*) from user_tb) as total_users,
            (select count(*) from recipe_tb) as total_recipes,
            (select count(*) from post_tb) as total_posts
    </select>

    <select id="getRecentActivities" resultMap="AdminActivityRespDtoMap">
        select
            *
        from
            (
            select
                'SIGNUP' as type,
                'CREATED' as action,
                ut.user_id as target_id,
                null as title,
                ut.username as username,
                ut.create_dt as occurred_at
            from
                user_tb ut

        union all

            select
                'POST' as type,
                'CREATED' as action,
                pt.post_id as target_id,
                pt.title as title,
                ut.username as username,
                pt.create_dt as occurred_at
            from
                post_tb pt
                inner join user_tb ut
                on ut.user_id = pt.user_id

        union all

            select
                'POST' as type,
                'UPDATED' as action,
                pt.post_id as target_id,
                pt.title as title,
                ut.username as username,
                pt.update_dt as occurred_at
            from
                post_tb pt
                inner join user_tb ut
                    on ut.user_id = pt.user_id
            where
                pt.update_dt is not null
                and pt.update_dt != pt.create_dt

        union all

            /* recipe created: target_id = recipe_id */
            select
                'RECIPE' as type,
                'CREATED' as action,
                rt.recipe_id as target_id,
                rt.title as title,
                ut.username as username,
                rt.create_dt as occurred_at
            from
                recipe_tb rt
                inner join user_tb ut
                    on ut.user_id = rt.user_id

            union all

            select
                'RECIPE' as type,
                'UPDATED' as action,
                rt.recipe_id as target_id,
                rt.title as title,
                ut.username as username,
                rt.update_dt as occurred_at
            from
                recipe_tb rt
                inner join user_tb ut
                    on ut.user_id = rt.user_id
            where
                rt.update_dt is not null
                and rt.update_dt != rt.create_dt
            ) a
        order by
            a.occurred_at desc
        limit
            #{limit}
    </select>


    <!-- =========================
         3) timeseries (graph)
            params:
            - metric: users | recipes
            - bucket: day | month | year
            - from/to: LocalDateTime (nullable)
         ========================= -->
    <select id="getTimeSeries" resultMap="AdminTimeSeriesPointDtoMap">
        <choose>
            <!-- users -->
            <when test="metric == 'users'">
                select
                    <choose>
                        <when test="bucket == 'day'">date_format(ut.create_dt, '%Y-%m-%d')</when>
                        <when test="bucket == 'month'">date_format(ut.create_dt, '%Y-%m')</when>
                        <otherwise>date_format(ut.create_dt, '%Y')</otherwise>
                    </choose>
                    as date,
                    count(*) as count
                from
                    user_tb ut
                where
                    1 = 1
                <if test="from != null">
                    and ut.create_dt &gt;= #{from}
                </if>
                <if test="to != null">
                    and ut.create_dt &lt;= #{to}
                </if>
                group by
                    date
                order by
                    date
            </when>

            <!-- recipes -->
            <when test="metric == 'recipes'">
                select
                    <choose>
                        <when test="bucket == 'day'">date_format(rt.create_dt, '%Y-%m-%d')</when>
                        <when test="bucket == 'month'">date_format(rt.create_dt, '%Y-%m')</when>
                        <otherwise>date_format(rt.create_dt, '%Y')</otherwise>
                    </choose>
                    as date,
                    count(*) as count
                from
                    recipe_tb rt
                where
                    1 = 1
                    <if test="from != null">
                        and rt.create_dt &gt;= #{from}
                    </if>
                    <if test="to != null">
                        and rt.create_dt &lt;= #{to}
                    </if>
                group by
                    date
                order by
                    date
            </when>

            <!-- posts -->
            <when test="metric == 'posts'">
                select
                    <choose>
                        <when test="bucket == 'day'">date_format(pt.create_dt, '%Y-%m-%d')</when>
                        <when test="bucket == 'month'">date_format(pt.create_dt, '%Y-%m')</when>
                        <otherwise>date_format(pt.create_dt, '%Y')</otherwise>
                    </choose>
                    as date,
                    count(*) as count
                from
                    post_tb pt
                where
                    1 = 1
                    <if test="from != null">
                        and pt.create_dt &gt;= #{from}
                    </if>
                    <if test="to != null">
                        and pt.create_dt &lt;= #{to}
                    </if>
                group by
                    date
                order by
                    date
            </when>

            <!-- unknown metric fallback -->
            <otherwise>
                select
                    null as date,
                    0 as count
            </otherwise>
        </choose>
    </select>
</mapper>
