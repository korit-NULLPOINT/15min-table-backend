<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nullpoint.fifteenmintable.mapper.AuthSessionMapper">

    <resultMap id="AuthSessionResultMap" type="com.nullpoint.fifteenmintable.entity.AuthSession">
        <id property="authSessionId" column="auth_session_id"/>
        <result property="sessionId" column="session_id"/>
        <result property="userId" column="user_id"/>
        <result property="refreshTokenHash" column="refresh_token_hash"/>
        <result property="status" column="status"/>
        <result property="ip" column="ip"/>
        <result property="userAgent" column="user_agent"/>
        <result property="lastUsedDt" column="last_used_dt"/>
        <result property="expiresDt" column="expires_dt"/>
        <result property="revokedDt" column="revoked_dt"/>
        <result property="createDt" column="create_dt"/>
        <result property="updateDt" column="update_dt"/>
    </resultMap>

    <insert id="insertSession" useGeneratedKeys="true" keyProperty="authSessionId">
        insert into auth_session_tb (
            session_id,
            user_id,
            refresh_token_hash,
            status,
            ip,
            user_agent,
            last_used_dt,
            expires_dt,
            revoked_dt,
            create_dt,
            update_dt
        )
        values (
            #{sessionId},
            #{userId},
            #{refreshTokenHash},
            #{status},
            #{ip},
            #{userAgent},
            #{lastUsedDt},
            #{expiresDt},
            #{revokedDt},
            #{createDt},
            #{updateDt}
        )
    </insert>

    <select id="getBySessionId" resultMap="AuthSessionResultMap">
        select
            *
        from
            auth_session_tb
        where
            session_id = #{sessionId}
        limit 1
    </select>

    <update id="rotateSession">
        update
            auth_session_tb
        set
            refresh_token_hash = #{refreshTokenHash},
            expires_dt = #{expiresDt},
            last_used_dt = #{lastUsedDt},
            update_dt = #{updateDt}
        where
            session_id = #{sessionId}
            and status = 'ACTIVE'
    </update>

    <update id="revokeSession">
        update
            auth_session_tb
        set
            status = 'REVOKED',
            revoked_dt = #{revokedDt},
            update_dt = #{updateDt}
        where
            session_id = #{sessionId}
            and status = 'ACTIVE'
    </update>
</mapper>
